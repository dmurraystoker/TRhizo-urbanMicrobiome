---
title: "TRhizo-urbanMicrobiome"
subtitle: "Urbanization Metrics"
author: "David Murray-Stoker"
output:
  pdf_document:
    toc: true
    toc_depth: 4
    fig_caption: yes
    latex_engine: xelatex
always_allow_html: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
knitr::opts_chunk$set(results = "hold", fig.pos = "H", fig.align = "center", out.width = "92.5%")
options(knitr.graphics.error = FALSE)
kableExtra::usepackage_latex("float")
```

```{r Load Packages for R Markdown, include = FALSE}
library(kableExtra)
library(knitr)
```





\newpage
# Load Packages

\vspace{10pt}

```{r Load Packages, include = FALSE}
## Load the tidyverse
library(tidyverse)

## Packages for analysis
library(geosphere)
library(MODISTools)
library(raster)

## Read in data
site.data <- read_csv(
  "data/urbanMicrobiome-site_information.csv",
  col_types = c("fnn"),
  show_col_types = FALSE
)
```




\newpage
# Urbanization Metrics

\vspace{10pt}

## Distance from the Urban Center

\vspace{10pt}

```{r Distance from the Urban center, echo = TRUE}
distance.data <- data.frame("Distance" = numeric(length = 35))

for (x in 1:35) {
  site.from.UC <- distm(
    x = site.data[x, c(3, 2)],
    y = c(-79.383276, 43.651536),
    fun = distGeo
  )

  site.from.UC.km <- site.from.UC / 1000

  distance.data[x, ] <- site.from.UC.km
}

## Add a Population identifier to each row
distance.data$Population <- site.data$Population

## Set column structure
distance.data$Population <- as_factor(distance.data$Population)
```



\newpage
## Impervious Surface Cover

\vspace{10pt}

```{r Calculate ISC Data, echo = TRUE}
## Set the path to the ISC raster
ISC_raster_path <- "raster_files/CAN_gmis_impervious_surface_percentage_geographic_30m.tif"

## Set the function to extract ISC values
calculate_ISC <- function(df, raster_path, buffer = 500) {
  # Load in raster for country
  raster <- raster::raster(raster_path)

  # Create spatial point dataframe from latitude and longitude
  spdf <- sp::SpatialPointsDataFrame(
    coords = df %>%
      dplyr::select(Longitude, Latitude),
    proj4string = raster@crs,
    data = df
  )

  # Calculate ISC data for population
  ISC_data <- raster::extract(x = raster, y = spdf, method = "simple", buffer = buffer)
  ISC_data <- ifelse(is.na(ISC_data), 255, ISC_data) # Missing data needs to be 255

  # Take mean ISC across all cells included within buffer
  ISC_data_mod <- ISC_data %>%
    # Convert ISC values of 200 to 0, as per documentation
    # Convert ISC values of 255 to missing
    map(., function(x) {
      case_when(
        x == 200 ~ 0,
        x == 255 ~ NA_real_,
        TRUE ~ x
      )
    }) %>%
    map(., mean, na.rm = TRUE) %>% # Ignore cells with missing ISC values when calculating mean
    unlist()

  # Add column with ISC values
  df_out <- df %>%
    mutate(
      Mean_ISC = ISC_data_mod,
      Mean_ISC = ifelse(Mean_ISC == 255, NA, Mean_ISC)
    )

  # Reorganize the data
  df_out <- df_out %>%
    dplyr::select(Population, Mean_ISC)

  return(df_out)
}

## Calculate ISC data in a dataframe
ISC.data <- calculate_ISC(df = site.data, raster_path = ISC_raster_path) %>%
  as_tibble()
```



\newpage
## Human Influence Index

\vspace{10pt}

```{r Calculate HII Data, echo = TRUE}
## Set the path to the HII raster
HII_raster_path <- "raster_files/HII_raster/hii_v2geo/w001001.adf"

## Set the function to extract HII values
calculate_HII <- function(df, raster_path) {
  # Load in the raster
  raster <- raster::raster(raster_path)

  # Create spatial point dataframe from latitude and longitude
  spdf <- sp::SpatialPointsDataFrame(
    coords = df %>%
      dplyr::select(Longitude, Latitude),
    proj4string = raster@crs,
    data = df
  )

  # Calculate HII data for each population
  HII_data <- raster::extract(x = raster, y = spdf, method = "simple")

  # Add column with HII values
  df_out <- df %>%
    mutate(
      Human_Influence_Index = HII_data,
      Human_Influence_Index = ifelse(Human_Influence_Index == 255, NA, Human_Influence_Index)
    )

  # Reorganize the data
  df_out <- df_out %>%
    dplyr::select(Population, Human_Influence_Index)

  return(df_out)
}

## Calculate HII data in a dataframe
HII.data <- calculate_HII(df = site.data, raster_path = HII_raster_path) %>%
  as_tibble()
```





\newpage
# Data Management & Export

```{r Urbanization Metric Data Management, echo = TRUE}
## Join all urbanization metrics into single dataframe
full.urbanization.data <- site.data %>%
  full_join(distance.data, by = "Population") %>%
  full_join(HII.data, by = "Population") %>%
  full_join(ISC.data, by = "Population")


## Export full urbanization data
write_rds(full.urbanization.data, file = "data/urbanization_data.rds")
```










\newpage
# R Session Information

```{r R Packages, echo = FALSE}
df_session_packages <- devtools::session_info()$packages %>%
  as.data.frame(.) %>%
  filter(attached == TRUE) %>%
  dplyr::select(loadedversion, date) %>%
  rownames_to_column()

colnames(df_session_packages) <- c("Package", "Loaded Version", "Date")

kable(
  df_session_packages,
  booktabs = TRUE,
  caption = "Packages required for data management and analysis."
) %>%
  kable_styling(
    full_width = FALSE,
    latex_options = c("HOLD_position", "striped")
  )
```
